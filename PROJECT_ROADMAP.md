# ChatRoom 个人项目开发路线图

> 本文档面向本仓库维护者，用于指导从「能跑的教学 Demo」逐步演进为结构清晰、可维护、有测试、有监控的个人项目。

---

## 一、总体目标

- **学习目标**：
  - 系统练习 Go 后端（Gin、GORM、JWT、WebSocket）。
  - 了解前端基础工程化与实时交互模式。
  - 掌握测试、监控、部署等工程实践。
- **项目目标**：
  - 以当前 ChatRoom 为基础，从「能跑」逐步演进为小型产品级应用：
    - 结构清晰、职责分层合理；
    - 关键路径有测试覆盖；
    - 具备基础监控与部署方案。

建议按照阶段推进，而不是一次性大改。每一阶段都可以形成一个相对独立的「里程碑」。

---

## 二、阶段总览

- **阶段 0：环境与基线跑通**  —— 保证自己能稳定跑起来、完整体验一遍。
- **阶段 1：代码理解与文档补全** —— 彻底搞懂现有设计和关键流程。
- **阶段 2：后端质量与安全增强** —— 错误处理、日志、配置、安全加固。
- **阶段 3：测试与工程化** —— 补单元/集成测试，接上基础 CI。
- **阶段 4：前端重构与交互体验** —— 拆分模块、优化 UX、提升可维护性。
- **阶段 5：功能扩展（可选）** —— 富文本、房间权限、多实例扩展等进阶功能。
- **阶段 6：部署与监控完善** —— Docker 化、部署示例、监控与告警。

可根据个人时间与兴趣选择性深入某些阶段，例如更偏向后端/测试或更偏向前端/DevOps。

---

## 三、阶段 0：环境与基线跑通

**目标**：保证本地开发环境稳定，熟悉最基本的运行与使用流程。

- **[P0-01] 阅读项目元信息**
  - 阅读仓库根目录下的 `AGENTS.md`，了解项目结构、开发命令和约定。
  - 阅读 `docs/DESIGN.md`，理解系统模块划分与关键流程。

- **[P0-02] 启动开发环境**
  - 启动数据库：`docker compose up -d postgres`。
  - 启动后端服务：`go run ./cmd/server` 或使用 `scripts/dev.sh`。

- **[P0-03] 手动全流程回归**
  - 在浏览器中访问首页：完成注册、登录。
  - 创建新房间、进入房间、发送消息。
  - 打开多个浏览器窗口/标签，验证 WebSocket 实时广播是否正常。

- **[P0-04] 记录初始问题清单**
  - 在使用过程中，将遇到的 Bug、错误提示不清、体验不佳点记录在一个 TODO 区域（可以放在本文件末尾或单独的 `TODO.md` 中），为后续阶段提供输入。

---

## 四、阶段 1：代码理解与文档补全

**目标**：对现有代码有整体掌握，为后续重构和测试做准备。

- **[P1-01] 模块结构梳理**
  - 通读目录结构，整理模块依赖关系：
    - `cmd/server`：入口，加载配置、初始化日志、连接 DB、构建 Router。
    - `internal/config`：配置与环境变量。
    - `internal/db`：数据库连接与迁移。
    - `internal/server`：Gin Router 与 REST handler。
    - `internal/auth`：鉴权、JWT、刷新令牌、中间件。
    - `internal/ws`：Hub/RoomHub/Client，房间广播与 WebSocket 管理。
    - `internal/mw`、`internal/metrics`、`internal/log`：限流、监控、日志。
    - `web/`：前端静态资源。
  - 可以在 `docs/` 中增加一个简单的「模块关系图」（手绘或 Markdown 说明均可）。

- **[P1-02] HTTP API 汇总**
  - 通读 `internal/server/router.go`，把主要接口整理成一个表格：
    - 路径、方法、请求体字段、响应体字段、是否需要鉴权。
  - 这个表既可以放在本文件，也可以放在 `docs/API.md`。

- **[P1-03] WebSocket 流程理解**
  - 通读 `internal/ws/hub.go` 和 `internal/ws/conn.go`：
    - `Hub` / `RoomHub` / `Client` 三者职责划分；
    - 房间的创建时机与 goroutine 生命周期；
    - `join/leave/typing/message` 事件是如何在房间内广播的。
  - 标记出目前你不太确定的点，例如：
    - RoomHub 何时结束/是否有内存泄漏风险；
    - 异常 client 断开时的资源清理等。

- **[P1-04] 简要开发说明补全（可选）**
  - 如果现有 README 对新手不够友好，可以计划后续增加：
    - 项目简介；
    - 快速启动步骤；
    - 主要 API/WS 地址说明；
    - 常见问题 FAQ。

---

## 五、阶段 2：后端质量与安全增强

**目标**：让服务在出现异常时“可预期”、有日志、对外暴露的行为更安全。

- **[P2-01] 配置加载与安全加固**
  - 在 `internal/config/config.go` 中：
    - 为 `ACCESS_TOKEN_TTL_MINUTES`、`REFRESH_TOKEN_TTL_DAYS` 的解析失败设置安全的默认值；
    - 当 `APP_ENV != dev` 且 `JWT_SECRET` 仍为默认值（如 `dev-secret-change-me`）时，直接 `log.Fatal` 退出。

- **[P2-02] 关键路径错误处理完善**
  - 在 `internal/server/router.go` 中：
    - 注册/登录/刷新 token 时，避免 `HashPassword`、`GenerateAccessToken`、`GenerateRefreshToken`、`SaveRefreshToken` 等错误被直接忽略；
    - 对外返回合理的 HTTP 状态码和错误信息，同时打结构化日志。
  - 在 `internal/ws/conn.go` 中：
    - WebSocket 升级失败时记录错误和请求上下文；
    - 消息入库失败时至少要记录日志，必要时告知客户端。

- **[P2-03] 日志规范化**
  - 基于 `internal/log` 中的 zerolog 初始化，约定统一的日志字段：
    - 如 `user_id`、`room_id`、`path`、`remote_ip` 等。
  - 为下面这些操作增加关键日志：
    - 登录成功/失败；
    - 创建房间；
    - WebSocket 连接建立/关闭；
    - DB 操作异常；
    - 鉴权失败等。

- **[P2-04] 安全策略加强**
  - WebSocket 鉴权：
    - 在生产环境禁用 `?token=` 形式传递 access token，仅允许 `Authorization: Bearer` 头部（可根据 `APP_ENV` 或配置开关控制）。
  - 输入校验：
    - 为用户名、房间名、消息内容添加长度限制，过滤掉明显非法输入；
    - 对分页参数（如 `limit`、`before_id`）做更严格的范围校验，防止滥用。

- **[P2-05] 初步服务层抽象（可逐步进行）**
  - 为用户/房间/消息相关操作引入简单的 service/repository 层，减少 handler 直接操作 `gorm.DB`：
    - 例如：`UserService` 负责注册/登录；
    - `RoomService` 负责创建房间、查询房间列表；
    - `MessageService` 负责消息查询与入库。
  - 先从登录、创建房间、发送消息这几个典型场景开始抽象，避免一次性大改。

---

## 六、阶段 3：测试与工程化

**目标**：为关键模块补充测试，建立最基本的工程“安全网”。

- **[P3-01] 初始化测试骨架**
  - 在以下包中创建 `_test.go` 文件：
    - `internal/auth`；
    - `internal/ws`；
    - `internal/server`（部分 handler）。
  - 确保 `go test ./...` 至少能正常跑通，即使一开始只有少量测试。

- **[P3-02] auth 模块单元测试**
  - 密码哈希与验证：
    - 同一密码多次哈希结果不同；
    - 哈希后的密码能被正确验证；
    - 错误密码无法通过校验。
  - JWT：
    - 正常签发/解析；
    - 过期 token 的处理；
    - 签名错误的处理。
  - Refresh token：
    - 生成、保存、校验、撤销的完整生命周期。

- **[P3-03] ws.Hub / RoomHub 逻辑测试**
  - 使用 fake client（带 `send` channel）替代真实 WebSocket 连接，对以下行为做测试：
    - 多个 client 注册/注销后，`Online()` 数量准确；
    - `broadcast` 能被所有在线 client 接收到；
    - client 发送消息后，RoomHub 内部状态正确更新。

- **[P3-04] HTTP handler 集成测试**
  - 使用 `net/http/httptest` 构造请求，测试：
    - 注册/登录/刷新 token；
    - 创建房间、获取房间列表；
    - 获取消息列表（含分页参数）。
  - 覆盖典型错误路径：
    - 缺少 token；
    - 无效 token；
    - 非法 room id/参数。

- **[P3-05] 简单 CI 集成（可选，但推荐）**
  - 选择常用 CI 平台（如 GitHub Actions），添加工作流：
    - 执行 `go test ./... -race -cover`；
    - 可选增加 `go vet`、`staticcheck` 等静态检查。

---

## 七、阶段 4：前端重构与交互体验

**目标**：让前端代码更易读、更易扩展，同时改善基本用户体验和错误反馈。

> 当前 `web/` 下为 `index.html` + `app.js` 的单文件结构，可逐步拆分。

- **[P4-01] 前端模块拆分**
  - 将 `app.js` 根据职责拆分为多个模块（可以使用原生 ES Modules）：
    - `api.js`：封装 REST 请求（注册、登录、房间、消息）。
    - `ws.js`：封装 WebSocket 连接管理、重连策略、事件订阅/分发。
    - `ui.js` 或 `view.js`：DOM 查询/更新，渲染房间列表和消息列表。
    - `state.js`：集中管理当前用户信息、当前房间、连接状态等。
  - 在不引入重框架的前提下，先做到**职责清晰、模块边界清楚**。

- **[P4-02] 状态与错误反馈优化**
  - 在界面上明确展示：
    - 当前登录用户；
    - 当前房间名称与在线人数；
    - WS 连接状态（连接中/已连接/已断开）。
  - 对常见错误给出可见提示：
    - 登录失败（用户名不存在/密码错误）；
    - 房间不存在或无权限；
    - WS 断开。

- **[P4-03] 安全与 XSS 防护（基础版）**
  - 评估 access token 的前端存储方式（`localStorage` / `sessionStorage` / cookie）：
    - 教学场景可以先简化，但要在代码和文档中明确风险。
  - 输出渲染时避免直接使用 `innerHTML` 注入用户输入；
  - 对消息内容做简单转义，减少 XSS 风险。

- **[P4-04] 交互体验小改进**
  - 输入框支持：Enter 发送消息、Shift+Enter 换行。
  - 新消息自动滚动到最新位置（同时考虑大量消息时的性能）。
  - 展示 typing 状态、在线人数等后端已经提供的能力。

---

## 八、阶段 5：功能扩展（进阶，可选）

**目标**：在已有稳定基础上，尝试更有挑战性的功能，强化对后端/前端/数据库的综合掌控。

- **[P5-01] 消息富文本 / 图片**
  - 后端：
    - 为 `models.Message` 增加 `metadata JSONB` 字段（需要迁移方案，避免直接依赖 AutoMigrate）。
    - 设计消息类型：纯文本、图片、代码块等。
  - 前端：
    - 支持粘贴图片或上传图片；
    - 渲染代码块/高亮等。

- **[P5-02] 房间权限与私密房间**
  - 数据层：
    - 为 `rooms` 表增加 `visibility` 字段（public/private），可选 `password` 字段。
  - 接口层：
    - 创建房间时支持设置可见性；
    - 列表接口仅返回用户有权限看到的房间。
  - 前端：
    - 在创建房间表单中增加权限选项；
    - 为私密房间增加加入验证流程。

- **[P5-03] 多实例扩展（分布式进阶）**
  - 研究如何用 Redis Pub/Sub、Redis Stream 或 NATS 等做跨进程广播：
    - 将当前单进程内的 RoomHub 变为“某个节点的本地订阅者”；
    - 所有节点通过消息中间件同步聊天消息和事件。

---

## 九、阶段 6：部署与监控完善

**目标**：让项目具备一套可复用的部署方式和基础的监控可视化。

- **[P6-01] 应用容器化**
  - 为 Go 服务编写 `Dockerfile`（多阶段构建，减小镜像体积）；
  - 在 `docker-compose.yml` 中增加应用服务，联通 Postgres。

- **[P6-02] 生产部署示例（简化版）**
  - 提供一个部署示例说明：
    - 使用 Nginx/Caddy 作为反向代理，启用 HTTPS；
    - 通过环境变量配置 `APP_PORT`、`DATABASE_DSN`、`JWT_SECRET` 等；
    - 提供 `.env.example` 展示推荐的配置键。

- **[P6-03] 监控与可观测性**
  - 在 `docs/` 中记录如何使用 `/metrics` + Prometheus + Grafana：
    - 示例 Prometheus 配置；
    - 示例 Grafana Dashboard（可贴 JSON 或给出关键图表说明）。
  - 为关键错误场景增加指标：
    - 鉴权失败次数；
    - DB 错误次数；
    - WS 连接失败/断开次数等。

---

## 十、个人 TODO 使用建议

- 可以在本文件中勾选/标记已完成的任务，例如：
  - 使用复选框语法：`- [x] 已完成任务` / `- [ ] 待完成任务`；
  - 或在每个阶段下新增一个「进度」小节。
- 也可以在根目录新建专门的 `TODO.md`，把更细粒度的日常任务放在那里，本文件保持相对稳定的“路线图”视角。

当你完成某一阶段后，可以回到这里回顾一下收获，并根据新的理解调整后续阶段的优先级或内容。这也是个人项目最有价值的部分：不仅写了代码，还持续迭代了自己的工程思维。
